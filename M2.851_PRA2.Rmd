---
title: 'Práctica 2: Limpieza y análisis de datos'
author: "Daria Gracheva, Zechao Jin"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    toc: true
    toc_depth: 2
  pdf_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Descripción del dataset.

Hemos elegido el dataset "Wine quality dataset", un dataset de kaggle cuya fuente es el repositorio UCI Machine Learning (https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009; https://archive.ics.uci.edu/ml/datasets/Wine+Quality). Se trata de un dataset de 6497 observaciones, 11 atributos y 1 marca de clase.     
Resumen de datos: más precisamente son 2 datasets separados, para tipos tinto y blanco del vinho verde, el de vinos tintos contiene 1599 observaciones, y el de vinos blancos - 4898 observaciones, con que tenemos opción de trabajar con datasets separadamente o bien unir todas las observaciones y obtener la variebilidad natural tinto/blanco.           
Las clases de dataset corresopnden a la calidad del vino basandose en sus características físicas y químicas (sensory data), en una escala de 0 a 10. El paradigma de calidad y las características son facilmente interpretables y el ámbito del tema es generalmente conocido pues tiene un alto potencial de dar un resultado divulgativo.     

En cuanto a la finalidad del estudio, sería interesante jugar con los datos para estimar que caracteristicas influyen a la calidad y/o representan el color. ¿Las caracteristicas de calidad varian segun el color del vino? Como podemos distribuir la calidad para entenderlo empiricamente -qué agrupaciones podemos obtener y cual es el número de "categorías de calidad" más óptimo según los algoritmos?, o bien si podemos estudiar los vinos partiendo de otras variables.       
      
### Librerías
```{r message= FALSE, warning=FALSE}
# Cargamos las librerías
library(ggplot2) # visualization
library(patchwork)
library(tidyverse)
library(corrplot)
library(factoextra) # clustering
library(Hmisc) # impute
library(arules) # discretize
library(DMwR) # smote
library(DescTools) # box-cox
```


# Integración y selección de los datos de interés a analizar.

Cargamos los dos datasets y concatenamos los datos de vinos tintos y blancos:
```{r message= FALSE, warning=FALSE}
# Carga del dataset
red <- read.csv('https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv', header = TRUE, sep = ";")

white <- read.csv('https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-white.csv', header = TRUE, sep = ";")

# Nombres de los atributos
names(red) <- c("fixed acidity", "volatile acidity", "citric acid", "residual sugar", "chlorides", "free sulfur dioxide", "total sulfur dioxide" , "density", "pH", "sulphates", "alcohol", "quality")

names(white) <- c("fixed acidity", "volatile acidity", "citric acid", "residual sugar", "chlorides", "free sulfur dioxide", "total sulfur dioxide" , "density", "pH", "sulphates", "alcohol", "quality")

# Creamos las columnas de color
red['color'] <- 'red'
white['color'] <- 'white'

# Fusionamos los dos datasets
vinos <- rbind(white,red)

# Factorizamos la variable color
vinos$color <- as.factor(vinos$color)

# Verificamos la estructura del conjunto de datos
str(vinos)
```
     
     
Se observa que tenemos todas las variables numéricas menos el atributo de color.       
Descripción de variables: son las características físicas o químicas del vino más su calidad y su color/tipo (tinto o blanco)       
fixed acidity       : acidez fija (g/l), v. continua    
volatile acidity    : acidez volatil (g/l), v. continua     
citric acid         : acido citrico (g/l), v. continua   
residual sugar      : azucar residual (g/l), v. continua    
chlorides           : cloruros (g/l), v. continua    
free sulfur dioxide : dioxido de azufre libre  (mg/l), v. continua    
total sulfur dioxide: dioxido de azufre total (mg/l), v. continua    
density             : densidad  (g/l), v. continua     
pH                  : pH, v. continua    
sulphates           : sulfatos (g/l), v. continua    
alcohol             : concentracción de alcohol (%%), v. continua     
quality             : calidad, v. discreta     
color               : color, v. cualitativa dicotómica     


Veamos como son algunas de las observaciones:
```{r}
rbind(head(vinos,5), tail(vinos,5))
```


# Limpieza de los datos
Veamos las estadísticas básicas:
``` {r message= FALSE, warning=FALSE}
summary(vinos)
```
   
   
Todas los columnas parecen ser bastante limpias, no obstante aquí se observa la heterogeneidad de las variables (por ejemplo, cloruros que no superan 0.611 g/l y dioxido de sulfuro total que "alcanza" 440 mg/l: dado que tienen las unidades distintas se produce esta brecha).       
   
En cuanto a la calidad, el valor mínimo es 3 y el máximo es 9. Por lo que 1-10 es una escala "común", y la escala real sería 3-9. Comprobamos la distribución de calidad:

``` {r message= FALSE, warning=FALSE}
table(vinos$quality)
```
   
Con el atributo "quality" podemos tener 7 marcas de clase diferentes, aunque puede ser conveniente agruparlo en una variable discreta como vemos más adelante.     
   
Distribución de valores únicos de atributos:    
```{r message= FALSE, warning=FALSE}
apply(vinos,2, function(x) length(unique(x)))
```
   
Algunos atributos tienen la distribución bastante dispersa, que, si fuera necesario, podríamos agrupar en intervalos.    
   

## Valores nulos   
Comprobamos si hay valores nulos en en dataset    
```{r message= FALSE, warning=FALSE}
any(is.na(vinos)) 
any(vinos=="")
```


A partir de las estadísticas se ve que todas las variables tienen un mínimo distinto del cero menos la variable "citric acid", y podría tomar un 0 como un valor desconocido.      
Veamos la distribución de "citric acid":

```{r message= FALSE, warning=FALSE}
table(vinos$`citric acid`)
```
    
Observación "0" aparece 151 veces que supone apr. 2% de la distribución y es comparable con algunas otras frecuencias, por lo que puede ser valor real (="no siempre se añade el acido citrico") y no perdido o nulo.

## Unidades de medida   
Como hemos visto, hay variables que tienen distintas unidades de medidas (hablando de variables de misma naturaleza), podemos reducirlas a las mismas medidas (quedamos con g/l).     
Hay dos variables que usan otras unidades: "free/total sulfur dioxide", que en g/l tendrían la distribución parecida a la de "chlorides".

``` {r message= FALSE, warning=FALSE}
# Cambio de unidades de mg/l a g/l
vinos$`free sulfur dioxide` <- vinos$`free sulfur dioxide` * 0.001
vinos$`total sulfur dioxide` <- vinos$`total sulfur dioxide` * 0.001
```
   
Visualizamos de nuevo las estadísticas:   
``` {r message= FALSE, warning=FALSE}
summary(vinos)
```
    
## Outliers

El dataset parece tener outliers ya que en muchas variables la dfirenecia entre tercer quantil y el máximo es considerable.

Visualizamos los boxplots de todas las columnas:

``` {r message= FALSE, warning=FALSE}
bp1 <- vinos %>%
        gather(Attributes, values, c(1:11)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()
bp1
```
        
Se observa que la variable "residual sugar" tiene unos outliers muy distantes. Otros atributos tienen una escala diferente por lo que procedemos a visualizarlos sin "residual sugar" con distinta ampliación:

``` {r message= FALSE, warning=FALSE}
p1 <- vinos %>%
        gather(Attributes, values, c(1:3,5:11)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()

p2 <- vinos %>%
        gather(Attributes, values, c(2:3,5:10)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()

p3 <- vinos %>%
        gather(Attributes, values, c(2:3,5:8,10)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()

bp1 + p2 + p3 + plot_layout(nrow = 3)

```
     
Tenemos valores bastante anómalos, sobre todo en "citric acid", "free sulfur dioxide", "sulphates", "volatile acidity", "sulphates", "chlorides".

No obstante, son relativamente pocas observaciones por lo que se puede realizar una imputación por la mediana.      

Por ello, remplazamos los valores extremos segun el estadístico de boxplot por NA:      
```{r}
for (x in c("residual sugar","citric acid", "free sulfur dioxide", "sulphates", "volatile acidity", "chlorides", "total sulfur dioxide", "fixed acidity", "density", "alcohol", "pH")) {
  vinos[,x][vinos[,x] %in% (boxplot.stats(vinos[,x])$out) ] <- NA
}
```
Cantidad de outliers detectados:
```{r}
sapply(vinos, function(vinos) sum(is.na(vinos)))
```
Un ejemplo de observaciones con outliers:
```{r}
vinos[is.na(vinos$alcohol),]
```
Podemos ver que algunos valores atípicos se encuentran en las mismas observaciones.

Imputación por la mediana:
```{r}
vinos[,c(1:11)] <- apply(vinos[,c(1:11)], 2, impute)
```


Visualizamos los atributos de nuevo comparando con los boxplots anteriores:
``` {r message= FALSE, warning=FALSE}
bp2 <- vinos %>%
        gather(Attributes, values, c(1:11)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()

bp1 + labs(subtitle = "Vinos original") + bp2 + labs(subtitle = "Vinos sin outliers") + plot_layout(nrow = 2)

```
   
O bien omitiendo residual sugar:
```{r message= FALSE, warning=FALSE}
p2 <- vinos %>%
        gather(Attributes, values, c(1:3,5:11)) %>%
        ggplot(aes(x=Attributes, y=values, fill=Attributes)) + geom_boxplot(show.legend=FALSE) + coord_flip()

p1 + labs(subtitle = "Vinos original") + p2 + labs(subtitle = "Vinos sin outliers") + plot_layout(nrow = 2)
```
   
   
Aunque seguimos teniendo outliers segun estos boxplots en su definción más teórica, están más agrupados y, considerando que representan la variebilidad real del dataset, eliminamos los valores muy anómalos y demasiado dispersos que podían ser errores o inconsistencias. Por ello, hemos obtenido la distribución mucho menos sesgada. 


## Discretización 

Como se observa, la variable quality no está balanceada, y las clases que tienen pocas observaciones pueden presentar problemas en análisis así que es conveniente crear particiones con más observaciones. Por ello con el fin de equilibrar la marca de calidad y agruparlo de manera natural, se puede realizar la discretizacion de la variable.     
   
Veamos de nuevo sus estadísticas:

```{r message= FALSE, warning=FALSE}
summary(vinos$quality)

barplot(table(vinos$quality), xlab="quality", main = "quality") 

# Distribución de valores únicos
table(vinos$quality)
```
      
Tenemos 7 marcas de calidad ordinales de 6471 observaciones. En principio, no sabemos en cuantas particiones podemos agrupar las observaciones.     

Logicamente, por frecuencias no se puede crear 4 o más particiones equilibradas (6471 ÷ 4 = 1617, los números de observaciones de clases 5,6 son mayores). Por lo que podríamos crear 2 o 3 clases. Tenemos que se seguir la lógica real para agrupar la calidad, por lo que puede ser: alta/media/baja calidad o bien alta/no alta calidad. Visualizamos la distribución de clases segun el color:  


```{r message= FALSE, warning=FALSE}
ggplot(data = vinos,aes(x=color,fill=as.factor(quality)))+geom_bar(position="fill") + geom_hline(yintercept=0.333, alpha = 0.3) + geom_hline(yintercept=0.666, alpha = 0.3) + geom_hline(yintercept=0.5, alpha = 0.3, color='blue') + coord_flip()
```
     
Para poder trabajar posteriormente con una variable dicotómica de calidad, fijaremos el número de bins de 2, que representaria calidad alta/no alta.

Para poder determinar qué observaciones agrupamos en que clase de calidad, visualización de clases discretas segun si la particion se hace por igual frequencia / igual amplitud o clustering:

```{r}
par(mfrow=c(2,2))
 
hist(vinos$quality, breaks = 20, main = "Equal Frequency")
abline(v = discretize(vinos$quality, breaks = 2, onlycuts = TRUE), col = "red")
 
hist(vinos$quality, breaks = 20, main = "Equal Width")
abline(v = discretize(vinos$quality, method = "interval", breaks = 2, onlycuts = TRUE), col = "red")
 
hist(vinos$quality, breaks = 20, main = "Clustering")
abline(v = discretize(vinos$quality, method = "cluster", breaks = 2, onlycuts = TRUE), col = "red")
```

Creamos  las particiones como otro atributo para poder comparar las futuras agrupaciones con valores de quality. Aunque pueda ser redundante ahora, nos podría servir para ajustar las particiones de calidad en futuro. 

```{r message= FALSE, warning=FALSE}

vinos$`quality class`[vinos$quality<=5]="low"
vinos$`quality class`[vinos$quality>5]="high"

vinos$`quality class` <- as.factor(vinos$`quality class`)

# Creamos un factor ordinal 
vinos$`quality class` <- factor(vinos$`quality class`, levels = c("low","high"))

# Estructura de la variable
table(vinos$`quality class`)
```

  
Finalmente, convertimos la calidad en factor también: 
```{r message= FALSE, warning=FALSE}
vinos$quality <- as.factor(vinos$quality)

# Variable factorizada
str(vinos$quality)
```
   

     
Ahora tenemos un dataset de 6471 observaciones y 14 columnas, 3 de cuales se puede considerar clases / grupos de vinos reales: quality (7 niveles), quality class (2 niveles), color (2 niveles).



## Balanceo de clase color 
Si podemos considerar que los datos de clase de calidad están ahora balanceados, las observaciones de color no lo estan, por ello usamos el algortimo SMOTE para poder equilibrar las marcas de clase para tareas posteriores de análisis.

```{r}
vinos <- SMOTE(color ~ ., vinos)
```


```{r message= FALSE, warning=FALSE}
dim(vinos)
table(vinos$color)
table(vinos$quality)
```

Con ello tenemos un dataset de 11193 observaciones con vinos tintos/blancos más balanceados gracias a las nuevas observaciones "sinteticas" y como se observa, la calidad tiene la distribución parecida a la anterior.


# Análisis 
  
Volvemos a ver las estadicticas básicas de las variables: 
   
```{r}
summary(vinos)
```
   
Y la desviación típica de las variables continuas:
```{r}
apply(vinos[,c(1:11)], 2, sd)
```
   
Visualizamos las variables (en histograma / gráfico de barras):     
```{r}
col <- c("fixed acidity", "volatile acidity", "citric acid", "residual sugar", "chlorides", "free sulfur dioxide", "total sulfur dioxide" , "density", "pH", "sulphates", "alcohol")
par(mfrow=c(2,3))

for (name in col) {
  hist(vinos[,name], prob=TRUE, xlab=name, main = name) 
  lines(density(na.omit(vinos[,name])))  
}

barplot(table(vinos$quality), xlab="quality", main = "quality") 
```
      
Se observa que la distribucion de la mayoría de las variables es bastante sesgada y parece visualmente a la F-distribution. Suponemos que eso es debido a la natiraleza de indicadores físico-químicos. Ademas, la variable residual sugar tiene una cola por la derecha siquiera despues de tratamiento de los outliers, y su desviación estándar también es relativamente alta. 
   
Hemos visto las distribuciones univariantes del dataset, ahora nos interesa ver las relaciones entre variables, correlaciones, cuáles de las características son más representativas en cuanto a la calidad / color del vino, qué explica la variebilidad natural del dataset y/u otras inferencias que podemos obtener de visualizaciones.     
     
Veamos primero la distribución y las frecuencias relativas de variables por color:
```{r message= FALSE, warning=FALSE}
p1 <- ggplot(data=vinos,aes(x=`fixed acidity`,fill=color))+geom_histogram()
p2 <- ggplot(data=vinos,aes(x=`volatile acidity`,fill=color))+geom_histogram()
p3 <- ggplot(data=vinos,aes(x=`citric acid`,fill=color))+geom_histogram()
p4 <- ggplot(data=vinos,aes(x=`residual sugar`,fill=color))+geom_histogram()
p5 <- ggplot(data=vinos,aes(x=`chlorides`,fill=color))+geom_histogram()
p6 <- ggplot(data=vinos,aes(x=`free sulfur dioxide`,fill=color))+geom_histogram()
p7 <- ggplot(data=vinos,aes(x=`total sulfur dioxide`,fill=color))+geom_histogram()
p8 <- ggplot(data=vinos,aes(x=`density`,fill=color))+geom_histogram()+theme(axis.text.x = element_text(angle = 45, hjust = 1))
p9 <- ggplot(data=vinos,aes(x=`pH`,fill=color))+geom_histogram()
p10 <- ggplot(data=vinos,aes(x=`sulphates`,fill=color))+geom_histogram()
p11 <- ggplot(data=vinos,aes(x=`alcohol`,fill=color))+geom_histogram()

p12 <- ggplot(data=vinos,aes(x=`quality`,fill=color))+geom_bar()

p1 + p2 + p3 + p4 + p5 + p6 + p7 + p8 + p9 + p10 + p11 + p12 + plot_layout(ncol = 3) + plot_layout(guides = 'collect')
```
   
Se ve que en la mayoría de variables la distribución de vinos tintos y vinos blancos es relativamente diferente. En 'free sulfur dioxide' y 'total sulfur dioxide' la distribución de tintos tiende bastante más a la izquierda (valores menores) y en otras características hay sesgo a la derecha (valores más altos) - densidad, sulfatos, acidez volatil/fija, cloruros. Y algunas no tienen un sesgo muy pronunciado (alcohol, residual sugar). Muchas caractesristicas bien deben de depender del color del vino. 

## Analisis inferencial

Como bien tenemos dos conjuntos distintos por el color de vino, podemos comparar las cualidades de los dos, por ejemplo si existe una relacion entre el color de vino y su calidad en el dataset (o bien si son independientes) o por otro lado si hay diferencia en alcohol para vinos tintos/blancos y vinos de calidad baja/alta -con lo que podemos obtener conclusiones tangibles para explicar la naturaleza de vinos.

### Selección de grupos

Hacemos los subconjuntos de datos por el color y por la calidad:

```{r}
red <- vinos[vinos$color=='red',]
white <- vinos[vinos$color=='white',]
```

```{r}
high <- vinos[vinos$`quality class`=='high',]
low <- vinos[vinos$`quality class`=='low',]
```

### Test sobre independencia de color y calidad alta/baja del vino
Como calidad es la variable discreta, realizamos el test chi-squared para poder hacer inferencia sobre la calidad de los vinos, con la hipótesis nula que la calidad y color son estadísticamente independientes y la hipotesis alternativa que existe una relación entre el color y la calidad.
   
```{r}
# Tabla de contingencia
tc<-table( vinos$`quality class`, vinos$color )
tc
```

```{r}
# Test 
chisq.test(tc, correct=FALSE)
```
Segun el p-value podemos concluir que sí hay relacion entre el color de vino y la calidad en los datos observados, pudiendo concluir que los vinos blancos generalmente tienen mejor calidad.
   
### Test sobre la proporción de vinos de alta calidad según el color
Para comprobar los resultados anteriores, planteamos el contraste para determinar si la proporción de vinos de alta calidad es igual para vinos tintos y blancos.
Puesto que tenemos una muestra lo suficinetemente grande, podemos también realizar un test parametrico sobre la proporción. 

```{r}
pR <- dim(vinos[which(vinos$color=='red' & vinos$`quality class`=='high'),])[1]/dim(vinos[vinos$color=='red',])[1];
pW <- dim(vinos[which(vinos$color=='white' & vinos$`quality class`=='high'),])[1]/dim(vinos[vinos$color=='white',])[1];
nR <- dim(vinos[vinos$color=='red',])[1]
nW <- dim(vinos[vinos$color=='white',])[1]

success<-c(pR*nR, pW*nW) # vector de casos de "exito"
nn<-c(nR,nW) # vector de tamaño de muestras
prop.test(success, nn, alternative="two.sided", conf.level=0.95, correct=FALSE)
```
   
Por el p-value no podemos aceptar la hipotesis nula de igualdad de proporciones, por ello concluimos que las proporciones de vinos de alta calidad son distintos para vinos de distinto color, siendo igualmente el color blanco el que tiende a tener calidad más alta.   
   
### Test sobre alcohol en vinos blancos/tintos y de calidad alta/baja   
Test de hipotesis de contraste sobre la igualdad estadística de la media de alcohol en dos muestras respectivas es un test parametrico si podemos comprobar la suposición de normalidad de variable y segun la igualidad de varianzas eligiremos el test a realizar. 

#### Vinos blancos / tintos

##### Test de normalidad

Test de normalidad Shapiro-Wilk (que es mas robusto que el test de Kolmogorov-Smirnov)
```{r}
shapiro.test(red$alcohol)
shapiro.test(sample(white$alcohol,5000))
```

No podemos aceptar la normalidad, por ello hacemos la transformación de Box-Cox:

```{r}
red$alcohol <- BoxCox(red$alcohol, lambda = BoxCoxLambda(red$alcohol))
white$alcohol <- BoxCox(white$alcohol, lambda = BoxCoxLambda(white$alcohol))
```

```{r}
shapiro.test(red$alcohol)
shapiro.test(sample(white$alcohol,5000))
```

A pesar de realizacion de transformacion de Box-Cox, rechazamos la hipotesis nula de normalidad de distribucion.
Veamos las gráficas Q-Q:
```{r}
par(mfrow=c(1,2))
qqnorm(red$alcohol, main='red')
qqline(red$alcohol)
qqnorm(white$alcohol, main='white')
qqline(white$alcohol)
```
     
Aunque rechazamos la hipótesis nula de normalidad de datos, con el tamaño de la muestra por el teorema del límite central podemos asumir la normalidad de distribución de alcohol. Con ello realizamos el test de igualdad de varianzas de las muestras:


##### Test de homocedasticidad
   
```{r}
var.test(red$alcohol, white$alcohol, alternative = "two.sided")
```
   
De la misma manera, rechazamos la hipótesis nula de igualdad de varianzas por lo que el test estadístico que se realiza es de dos muestras con varianza poblacional desconocida pero distinta.   
   
##### Contraste sobre la media de alcohol en vinos blancos/tintos

```{r}
t.test(red$alcohol, white$alcohol, alternative='two.sided',var.equal=FALSE)
```
Por los resultados del test, con la confianza de 95% aceptamos la hipótesis de que el nivel promedio del alcohol es estadísticamente distinto en vinos blancos y tintos, con la diferencia real entre las dos medias en intervalo [-0.0015334921,-0.0008158837].
   
  
#### Vinos calidad alta / baja

Seguimos los mismos pasos para los subconjuntos según la calidad:

##### Test de normalidad

Test de normalidad Shapiro-Wilk:
```{r}
shapiro.test(sample(high$alcohol,5000))
shapiro.test(low$alcohol)
```

Transformación de Box-Cox:
```{r}
high$alcohol <- BoxCox(high$alcohol, lambda = BoxCoxLambda(high$alcohol))
low$alcohol <- BoxCox(low$alcohol, lambda = BoxCoxLambda(low$alcohol))
```

```{r}
shapiro.test(sample(high$alcohol,5000))
shapiro.test(low$alcohol)
```

A pesar de realizacion de transformación de Box-Cox, rechazamos la hipótesis nula de normalidad de distribución.
Veamos las gráficas Q-Q:
```{r}
par(mfrow=c(1,2))
qqnorm(high$alcohol, main='high')
qqline(high$alcohol)
qqnorm(low$alcohol, main='low')
qqline(low$alcohol)
```
       
Resultado es parecido que en los subconjuntos anteriores, por ello de la misma manera aplicamos el teorema del límite central para asumir la normalidad.


##### Test de homocedasticidad
   
```{r}
var.test(high$alcohol, low$alcohol, alternative = "two.sided")
```
   
De la misma manera, rechazamos la hipotesis nula de igualdad de varianzas por lo que el test estadístico que se realiza es de dos muestras con varianza poblacional desconocida pero distinta.   
   
##### Contraste sobre la media de alcohol en vinos blancos/tintos

```{r}
t.test(high$alcohol, low$alcohol, alternative='two.sided',var.equal=FALSE)
```
Por los resultados del test, igualmente, con la confianza de 95% aceptamos la hipótesis de que el valor promedio del alcohol es estadísticamente distinto en vinos de calidad alta y baja, con los vinos de alta calidad teniendo el valor promedio de alcohol mas alto.


### Conclusiones 
Por ello, podemos concluir que la variable alcohol puede ser importante tanto para la calidad como para el color del vino, y que hay además una relación estadística entre la calidad y el color. 


## Estudio de correlación entre las variables 

Podemos ver el correlograma visualizando las correlaciones entre las variables:
``` {r message= FALSE, warning=FALSE}
d <- vinos[1:11]
d$quality = as.numeric(vinos$quality)
d$color = as.numeric(vinos$color)

M<-cor(d)

corrplot(M, method="ellipse", type='lower',tl.col="black", tl.srt=45)
```
    
Se observa que, muchos atributos tienen correlación entre sí. Por ejemplo, fuerte correlación positiva presentan total sulfur dioxide y free sulfur dioxide, esperadamente. En general, density tiene correlación positiva con casi todas las características (sin contar color y calidad), bastante alta con "residual sugar", y solo con "alcohol" está fuerte y negativamente correlacionada. Las correlaciones entre atributos químicos pueden ser explicados por adición de las sustancias con el fin de nivelar/acentuar las otras características .     
     
Por otro lado, calidad no parece tener correlaciones muy importantes positivas o negativas con muchas de las características, no obstante las que mâs le puedan influir son alcohol (positivamente) y densidad (negativamente).      
    
No obstante, el color está más correlacionado con los atributos físico-químicos, como con "total sulfur dioxide" (positivamente), "volatile acidity" (negativamente), etc, donde los signos de correlación representaran: negativo -> vino tinto, positivo -> vino blanco. Hay que tener en cuenta que la dimensionalidad de la parte de vinos tintos en el dataset es distinta a la de vinos blancos, aunque debe de ser suficiente para obtener las correlaciones correctas.     
     
Algunas de correlaciones más signicativas:     
```{r message= FALSE, warning=FALSE}
p1 <- ggplot(data = vinos,aes(x=`free sulfur dioxide`,y=`total sulfur dioxide`))+geom_jitter(color="#0072B2", alpha=0.3) + geom_smooth(method='lm')
p2 <- ggplot(data = vinos,aes(x=`density`,y=`residual sugar`))+geom_jitter(color="#0072B2", alpha=0.3) + geom_smooth(method='lm')
p3 <- ggplot(data = vinos,aes(x=`citric acid`,y=`volatile acidity`)) + geom_jitter(color="#FF9966", alpha=0.3) + geom_smooth(method='lm')
p4 <- ggplot(data = vinos,aes(x=`alcohol`,y=`residual sugar`)) + geom_jitter(color="#FF9966", alpha=0.3) + geom_smooth(method='lm')
p1 + p2 + p3 + p4 
```

### Color 
Es inetersante ver qué color tiene las correlaciones más fuertes con atributos físicos y químicos de vinos que calidad.    
Veamos algunas de las características:
``` {r message= FALSE, warning=FALSE}
p1 <- ggplot(data = vinos,aes(x=`volatile acidity`,fill=color))+geom_density(alpha=0.7, outline.type = 'lower')
p2 <- ggplot(data = vinos,aes(x=`total sulfur dioxide`,fill=color))+geom_density(alpha=0.7, outline.type = 'lower')
p3 <- ggplot(data = vinos,aes(x=`chlorides`,fill=color))+geom_density(alpha=0.7, outline.type = 'lower')
p4 <- ggplot(data = vinos,aes(x=`sulphates`,fill=color))+geom_density(alpha=0.7, outline.type = 'lower')
p1 + p2 + p3 + p4 + plot_layout(guides = 'collect')
```
       
Las dos primeras características ("total sulphur dioxide" y "volatile acidity") resultan en distribuciones de densidad muy distintas entre tipos de vinos que confirma la correlación.
       
Además, podemos ver las agrupaciones por color visualizando dos variables opuestamente correlacionadas:
```{r message= FALSE, warning=FALSE}
ggplot(data = vinos, aes(x = `total sulfur dioxide`, y = `volatile acidity`, color = `color`)) + geom_point(alpha = 0.3)
```
    
Hay cierta tendencia bastante definida visualmente de agrupaciones de vinos tintos/blancos aunque las observaciones están todavía entremezcladas.    
       
Fijémonos en estas dos características: 

```{r message= FALSE, warning=FALSE}
p1 <- ggplot(data = vinos, 
       aes(x = `total sulfur dioxide`, y = `volatile acidity`, color = `color`)) +
   geom_point(alpha = 0.3)+facet_wrap(~color) 

p2 <- ggplot(data = vinos, 
       aes(x = `total sulfur dioxide`, y = `volatile acidity`, color = `color`)) +
   geom_point(alpha = 0.3)+facet_wrap(~`quality class`) 

p1 + p2 + plot_layout(guides = 'collect') + plot_layout(ncol = 1)

```
     
Las agrupaciones se mantienen en distintos grupos de calidad de vino.   
   
   
``` {r message= FALSE, warning=FALSE}
# Total sulfur dioxide
p1 <- ggplot(data = vinos,aes(x=`total sulfur dioxide`,fill=`color`))+geom_density(alpha=0.5, outline.type = 'lower')+facet_wrap(~color)

p2 <- ggplot(data = vinos,aes(x=`quality class`, y=`total sulfur dioxide`, color = `color`))+geom_boxplot()+facet_wrap(~`color`)

p1 + p2 + plot_layout(guides = 'collect')

```  
     
    
``` {r message= FALSE, warning=FALSE}
# Volatile acidity
p1 <- ggplot(data = vinos,aes(x=`volatile acidity`,fill=`color`))+geom_density(alpha=0.5, outline.type = 'lower')+facet_wrap(~color)

p2 <- ggplot(data = vinos,aes(x=`quality class`, y=`volatile acidity`, color = `color`))+geom_boxplot()+facet_wrap(~`color`)

p1 + p2 + plot_layout(guides = 'collect')

```   
   
Se ven claramente las diferencias en distribuciones de ambas características por color de vino y correlaciones positiva y negativa. Ya que "volatile acidity" también presntaba correlación con "quality", se observan diferencias por cada clase de calidad, pero principalmente en vinos tintos.     
     
   
   
### Calidad

La densidad y el alcohol pueden ser las características del vino que son las más responsables por la calidad del vino del dataset. También, hay correlaciones más bajas con volatile acidity, sin embargo, como hemos visto, principalmente se manifestan en un tipo de vinos (vinos tintos).      
      
Veamos las dos variables con más detalle para ver la relación entre ellas:
```{r message= FALSE, warning=FALSE}
ggplot(data = vinos, aes(x = density, y = alcohol, color = `quality class`)) + geom_point(alpha = 0.3) 
```

```{r message= FALSE, warning=FALSE}
p1 <- ggplot(data = vinos, 
       aes(x = density, y = alcohol, color = `quality class`)) +
   geom_point(alpha = 0.3)+facet_wrap(~color) 

p2 <- ggplot(data = vinos, 
       aes(x = density, y = alcohol, color = `quality class`)) +
   geom_point(alpha = 0.3)+facet_wrap(~`quality class`) 

p1 + p2 + plot_layout(guides = 'collect') + plot_layout(ncol = 1)

```
    
Aunque las clases están entremezclados, también se ve la tendencia de agrupaciones.     


``` {r message= FALSE, warning=FALSE}
# Alcohol
p1 <- ggplot(data = vinos,aes(x=alcohol,fill=`quality class`))+geom_density(alpha=0.5, outline.type = 'lower')+facet_wrap(~`quality class`)

p2 <- ggplot(data = vinos,aes(x=color, y=alcohol, color = `quality class`))+geom_boxplot()+facet_wrap(~`quality class`)

p1 + p2 + plot_layout(guides = 'collect')

```


```{r message= FALSE, warning=FALSE}
# Density

p1 <- ggplot(data = vinos,aes(x=density,fill=`quality class`))+geom_density(alpha=0.5, outline.type = 'lower')+facet_wrap(~`quality class`)+theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(data = vinos,aes(x=color, y=density, color = `quality class`))+geom_boxplot()+facet_wrap(~`quality class`)

p1 + p2 + plot_layout(guides = 'collect')
```
   
Observamos las correlaciones (positiva con alcohol y negativa con densidad) en ambos tipos/colores de vinos, aunque la densidad es la característica con una influencia más fuerte en vinos blancos. Se visualiza bien cómo el nivel de alcohol y  densidad cambian en distintas particiones de la calidad del vino del dataset.     


Hay tendencias de agrupamiento por valores de nivel de alcohol y densidad, pero al final la calidad debe de depender de un conjunto más grande de características físico-químicas ya que dos variables no explican totalmente la calidad, ni calidad explica la variebilidad del dataset.    
     
     
Finalmente, para aproximarnos al conjunto de características, podemos visualizar la relación entre 4 variables: density, alcohol, chlorides y quality class. Chlorides es la siguiente característica que tenía correlacion fuerte con quality despues de volatile acidity que lo presentaba mayormente en vinos tintos.      
``` {r message= FALSE, warning=FALSE}
ggplot(data = vinos, aes(x = density, y = alcohol, color = `quality class`)) + geom_point(aes(size = `chlorides`), alpha = 0.3) 
```
    
No hay relación lineal, pero se explican algunas observaciones "alejadas" (pertenecen a una partición de calidad pero se visualizan donde prevalece otra partición, pues tienen chlorides, por ejemplo, bajos, frente a la mayoría de su partición. Al final y a cabo muchos de los atributos influen a la densidad).      
   
 
     
## Regresión multiple

Como hemos observado, no hay una relacion lineal simple entre las variables, por ello se puede intentar explicar la calidad y el color linealmente con varios regresores a traves de algoritmo de regresion logística, dado que tanto el color como la clase de calidad son variables dicotómicas.

### Calidad

```{r}
model1 <- glm(`quality class`~`fixed acidity`+`volatile acidity`+`citric acid`+`residual sugar`+chlorides+`free sulfur dioxide`+`total sulfur dioxide`+density+pH+sulphates+alcohol, vinos, family=binomial(link=logit))
summary(model1)
```
Según el modelo, las variables fixed acidity, citric acid, pH no tienen significancia estadística para el modelo (p.value > 0.05 por lo que aceptamos la hipótesis que significancia es igual a cero).

Para ver los odds ratio para cada unidad de las caracteristicas:
```{r}
exp(coefficients(model1))
```
Puesto que las caracteristicas con valores superiores a uno son alcohol y residual sugar, podemos considerar alcohol el más influyente a la probabilidad en el modelo obtenido.

La bondad de ajuste se obtiene a traves del índice de Akaike AIC, que en este caso asciende a 13336, un valor muy alto. Podremos compararlo con el modelo posterior de regresión sobre el color. 

### Color 

```{r}
model2 <- glm(color~`fixed acidity`+`volatile acidity`+`citric acid`+`residual sugar`+chlorides+`free sulfur dioxide`+`total sulfur dioxide`+density+pH+sulphates+alcohol, vinos, family=binomial(link=logit))

summary(model2)
```
Se observan en este caso todas las variables significativas para el modelo, con los odds ratio respectivos de:

```{r}
exp(coefficients(model2))
```
según los que las variables explicativas parecen ser total sulfur dioxide, alcohol. 

El modelo es mas explicativo que el anterior, puesto que la bondad de ajuste es mejor con el AIC de 823. 

### Conclusiones

Podemos decir que no es facil encontrar un modelo lineal multiple que explique la varianza del dataset tanto para la probabilidad del color como de la calidad, entonces que el dataset no es linealmente separable. Otra manera poder explicar la varianza es realizar un estudio no supervisado y analizar las agrupaciones resultantes.


## Modelo no supervisado (clustering)
Normalizamos el dataset (solo los features), puesto que el algoritmo de clustering se basa en las distancias entre las observaciones.
```{r message= FALSE, warning=FALSE}
vinos_norm <-  scale(vinos[,1:11])
```

Tal y como hemos dicho anteriormente, aunque hemos estumado el numero de intervalos de calidad de 2 (alta/baja), no tiene por que ser un número óptimo de clusters segun las caracteristicas físico-químicas, por lo que estudiaremos las agrupaciones sin referencia a la marca de calidad y las aproximaremos al dataset con atributos caractrísticos del vino.

### Número óptimo de clusters
Con la librería factoextra y la función fviz_nbclust podemos visualizar el número óptimo calculado con metodos por siluetas medias y wss (suma de cuadrados): 

```{r message= FALSE, warning=FALSE}
# Metodo por siluetas medias
fviz_nbclust(vinos_norm, kmeans, method = "silhouette")
```

```{r}
# Metodo wss
fviz_nbclust(vinos_norm, kmeans, method = "wss")
```

El número óptimo de clusters parece ser 2, lo que está más claro por el metodo de siluetas pero no por el metodo de "codo", como se ha preliminarmente definido para el número de particiones de calidad. 
      
### Modelo clusters

``` {r message= FALSE, warning=FALSE}
set.seed(1234)
fit <- kmeans(vinos_norm, 2)

# Tamaño de los clusters obtenidos 
fit$size
```
       

Visualizamos los clusters:  
```{r message= FALSE, warning=FALSE}
fviz_cluster(fit, geom = "point",  data = vinos_norm)
```
           
Se observan que están bastante poco entremezclados, siendo el segundo cluster más poblado.           
           
Se puede ver la feature importance de las dimensiones de la gráfica que serán las mismas que los 2 primeros componentes de PCA:            
```{r}
var <- get_pca_var(prcomp(vinos_norm))
p1 <- fviz_contrib(prcomp(vinos_norm), choice = "var", axes = 1, top = 5)
p2 <- fviz_contrib(prcomp(vinos_norm), choice = "var", axes = 2, top = 5)
p1 + p2
```
           
           
           
Para poder aproximar las agrupaciones al dataset, visualizamos un gráfico con los atributos explicativos del dataset (no componentes).      
      
Para visualizar los gráficos con los atributos total sulfur dioxide y chlorides (dimensión 1):
```{r message= FALSE, warning=FALSE}
ggplot(vinos,aes(`total sulfur dioxide`, `chlorides`, color=as.factor(fit$cluster)))+geom_point()
ggplot(vinos,aes(`total sulfur dioxide`, `chlorides`, color=`quality class`))+geom_point()
ggplot(vinos,aes(`total sulfur dioxide`, `chlorides`, color=color))+geom_point()
```
    
Para visualizar ahora los gráficos con los atributos density y alcohol (dimensión 2):
```{r message= FALSE, warning=FALSE}
ggplot(vinos,aes(`density`, `alcohol`, color=as.factor(fit$cluster)))+geom_point()
ggplot(vinos,aes(`density`, `alcohol`, `chlorides`, color=`quality class`))+geom_point()
ggplot(vinos,aes(`density`, `alcohol`, `chlorides`, color=color))+geom_point()
```    
    
        
En este caso la aproximación de clusters puede captar la natiraleza de las variables segun su color pero no segun quality class, lo que significa que la discretización realizada no es muy significativa, pero que las caracteristicas tienen que ser distintas segun el color.      
             


# Conclusión / Resolución del problema. 
A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?

En principio no podemos concluir que sea posible determinar una calidad de vino segun su sensory data con alta precisión. Tenemos evidencia que el color sí que esta correlacionado con los atributos. 

(no acabado)
